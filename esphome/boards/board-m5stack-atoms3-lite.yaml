substitutions:
  restart_button: "Restart device"
  led_brightness: "LED Brightness"
  led_switch: "LED Aan/Uit"

###
## M5Stack atom S3 lite board, in combination with this base from m5stack:
## https://shop.m5stack.com/products/atomic-rs485-base
## NOTE: there are other RS485 boards from m5stack, these are not tested (like the tail-rs485)
#
esp32:
  board: esp32-s3-devkitc-1
  framework:
    #type: arduino
    type: esp-idf # For testing # succesvol getest met ESPHome versie 2025.12.4 

# uart for modbus rtu
uart:
  id: mod_bus
  baud_rate: 9600
  stop_bits: 1
  tx_pin: GPIO6
  rx_pin: GPIO5

### modbus ###
modbus:
  id: modbus1
  uart_id: mod_bus
  send_wait_time: 200ms
  #flow_control_pin: GPIO7  

# i2c for extra sensor
i2c:
  - id: bus_a
    sda: GPIO2
    scl: GPIO1

# Enable/Disable logging
logger:
  logs:
    modbus_controller.sensor: INFO
    modbus_controller.output: INFO
    modbus.number: INFO
    esp32.preferences: INFO
    sensor: INFO
    text_sensor: INFO
    dht.sensor: INFO
    switch: INFO
    button: INFO
    number: INFO
  # baud_rate: 0  # <--- super important! for ESP8266

captive_portal:

# Enable Web server.
web_server:
  port: 80

ota:
  platform: esphome

############################################
#  STATUS LED â€“ ATOM S3 LITE (GPIO 35)
############################################

light:
  - platform: esp32_rmt_led_strip
    id: led
    name: "Status LED"
    internal: true
    pin: 35
    num_leds: 1
    type: GRB
    variant: WS2812
    restore_mode: RESTORE_DEFAULT_OFF

    effects:
      - pulse:
          name: slow_pulse
          transition_length: 1s
          update_interval: 1s

      - pulse:
          name: fast_pulse
          transition_length: 0.3s
          update_interval: 0.3s

#  BOOT STATUS
esphome:
  name: ecodan
  friendly_name: Ecodan heatpump

  on_boot:
    priority: -10
    then:
      - light.turn_on:
          id: led
          red: 100%
          green: 100%
          blue: 100%
          brightness: 100%
          effect: none
          
#  WIFI STATUS
wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  on_connect:
    then:
      - light.turn_on:
          id: led
          red: 100%
          green: 100%
          blue: 100%
          effect: none

  on_disconnect:
    then:
      - light.turn_on:
          id: led
          red: 100%
          green: 0%
          blue: 0%
          effect: fast_pulse

  ap:
    ssid: "fallback"
    on_start:
      then:
        - light.turn_on:
            id: led
            red: 100%
            green: 100%
            blue: 100%
            effect: slow_pulse

#  API STATUS
api:
  on_disconnect:
    then:
      - light.turn_on:
          id: led
          red: 100%
          green: 100%
          blue: 0%
          effect: fast_pulse

#  CUSTOM STATUS SCRIPTS
script:
  - id: heating
    then:
      - light.turn_on:
          id: led
          red: 100%
          green: 65%
          blue: 0%
          brightness: 100%
          effect: none

  - id: cooling
    then:
      - light.turn_on:
          id: led
          red: 0%
          green: 0%
          blue: 100%
          brightness: 100%
          effect: none

  - id: hotwater
    then:
      - light.turn_on:
          id: led
          red: 100%
          green: 0%
          blue: 100%
          brightness: 100%
          effect: none

#G41=Button
binary_sensor:
  - platform: gpio
    name: Buttonw
    id: g41button
    pin:
      number: GPIO39
      inverted: true
      mode:
        input: true
#        pullup: true
    internal: true
    filters:
      - delayed_off: 10ms
    # Toggle the switch when the pushbutton is pressed
    on_press:
      then:
        - switch.toggle: ecodan_led_switch

###  ESP restart button
button:
  - platform: restart
    id: restart_button
    name: ${restart_button}

number:
  - platform: template
    id: led_brightness
    name: ${led_brightness}
    icon: mdi:toggle-switch-variant
    mode: slider
    entity_category: config
    optimistic: true
    min_value: 0
    max_value: 100
    step: 10
    initial_value: 70
    restore_value: yes
    unit_of_measurement: "%"
    on_value:
      then:
        - if:
            condition:
              light.is_on: status_led
            then:
              - light.turn_on:
                  id: status_led
                  brightness: !lambda |- 
                    return id(led_brightness).state / 100.0;

switch:
  - platform: template
    id: ecodan_led_switch
    name: ${led_switch}
    optimistic: true
    restore_mode: RESTORE_DEFAULT_ON 
    lambda: return id(ecodan_led_switch).state;
    turn_on_action:
      - light.turn_on:
          id: status_led
          brightness: !lambda |-
            // output value must be in range 0 - 1.0
            return id(led_brightness).state / 100.0;
    turn_off_action:
      - light.turn_off:
          id: status_led
